define fac(0) = 1 | fac(n) = n * fac(n-1) when n > 0;

{ Local synonyms for primitive constructors can be used for pattern matching }
define oppx = 
  let links = left in let f(links(x)) = right(x) in f;

define fibcps(n, k) =
  if n < 2 then k(n) else
   fibcps(n-1, function (x) fibcps(n-2, function (y) k(x+y)));

_install("Cell");
__token(#!, #monop, 0, 0); 
__token(#:=, #binop, 1, 1);
define ! = _primitive("!");
define := = _primitive(":=");

{ Knuth's Man or Boy test }
define mob(k) =
  let a(k0, x1, x2, x3, x4, x5) =
    if k0 <= 0 then
      x4() + x5()
    else (
      let k = new(k0) in
      let b() =
        k := !k-1 >>
        a(!k, b, x1, x2, x3, x4) in
      b() ) in
  a(k, function () 1, function () -1, function () -1, 
       		      	       	    	function () 1, function () 0);

define trunk(x + 0.5) = x | trunk(x) = x;

define two3(x, [_, x, _]) = true | two3(_, _) = false;

define flic(n, x) =
  let flac(x) = [x+1, x+2] when numeric(x)
    | flac(x) = map(function (x) flac(x), x) in
  if n = 0 then x else flic(n-1, flac(x)); 
